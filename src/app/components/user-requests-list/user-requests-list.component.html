<div *ngIf="requests.length === 0" class="empty">
  No hay solicitudes para mostrar.
</div>

<div *ngFor="let req of requests"
     [id]="'request-' + req.id"
     class="request-card"
     [ngClass]="[getStatusClass(req), highlightedRequestId === req.id ? 'highlighted' : '']">
  <mat-card>
    <mat-card-header>
      <div class="header-content">
        <span> </span>
        <span class="chip" [ngClass]="getChipClass(req)">
          {{ getRequestStatus(req) }}
        </span>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="info-row">
        <span><strong>D.A:</strong> {{ req.da }}</span>
        <span><strong>N° Solicitud:</strong> {{ req.requestNumber }}</span>
        <span><strong>Ejercicio:</strong> {{ req.fiscalYear }}</span>
      </div>

      <div class="info-row">
        <span><strong>Importe:</strong> {{ req.amount | currency:'ARS':'symbol':'1.2-2':'es-AR' }}</span>
        <span><strong>Concepto:</strong> {{ req.concept }}</span>
        <span><strong>Vencimiento:</strong> {{ req.dueDate }}</span>
      </div>

      <div class="info-row">
        <span><strong>Enviado:</strong> {{ req.receivedAt | date:'dd/MM/yyyy HH:mm' }}hs</span>
        <span><strong>Fuente de financiamiento:</strong> {{ req.fundingSource }}</span>
        <span><strong>Cuenta corriente a acreditar:</strong> {{ req.checkingAccount }}</span>
      </div>

      <div *ngIf="req.comments">
        <strong>Notas / Comentarios:</strong> {{ req.comments }}
      </div>

      <div *ngIf="req.partialPayment > 0" class="highlight" [ngClass]="getPartialPaymentClass(req)">
       <strong>Pago parcial:</strong> {{ req.partialPayment | currency:'ARS':'symbol':'1.2-2':'es-AR' }}
        <button mat-button class="history-toggle" (click)="togglePaymentHistory(req.id)">
          <mat-icon>{{ isHistoryExpanded(req.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
          {{ isHistoryExpanded(req.id) ? 'Ocultar' : 'Ver' }} detalle
        </button>
      </div>

      <div *ngIf="req.partialPayment > 0 && isHistoryExpanded(req.id)" class="payment-history">
        <div *ngIf="isLoadingHistory(req.id)" class="loading">
          Cargando detalle...
        </div>
        <div *ngIf="!isLoadingHistory(req.id) && getPaymentHistory(req.id)" class="history-list">
          <h4>Detalle de pagos parciales:</h4>
          <div *ngFor="let payment of getPaymentHistory(req.id)" class="payment-item">
            <div class="payment-details">
              <span class="payment-amount">{{ payment.amount | currency:'ARS':'symbol':'1.2-2':'es-AR' }}</span>
              <span class="payment-date">{{ payment.createdAt | date:'dd/MM/yyyy HH:mm' }}hs</span>
            </div>
          </div>
        </div>
        <div *ngIf="!isLoadingHistory(req.id) && (!getPaymentHistory(req.id) || getPaymentHistory(req.id)?.length === 0)" class="no-history">
          No hay historial de pagos disponible.
        </div>
      </div>

      <div *ngIf="req.commentsFromTeso" class="highlight info">
        <mat-icon>message</mat-icon>
        <strong>Comentarios de Tesorería General:</strong> {{ req.commentsFromTeso }}
      </div>

      <div *ngIf="isEditable(req)" class="edit-container" >
        <button mat-raised-button class="action-button" [ngClass]="{'partial-payment-button': req.partialPayment > 0}" (click)="onEdit(req)">
           <mat-icon class="icon">edit</mat-icon> Modificar
        </button>
      </div>

    </mat-card-content>
  </mat-card>
</div>